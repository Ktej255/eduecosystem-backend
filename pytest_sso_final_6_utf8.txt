============================= test session starts =============================
platform win32 -- Python 3.13.2, pytest-9.0.1, pluggy-1.6.0 -- C:\Users\Sarit\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
rootdir: D:\Graphology\Master Software\Eduecosystem\backend
configfile: pytest.ini
plugins: anyio-4.11.0, asyncio-1.3.0, cov-7.0.0, mock-3.15.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 2 items

tests/api/api_v1/test_sso_integration.py::test_sso_full_flow PASSED      [ 50%]
tests/api/api_v1/test_sso_integration.py::test_sso_saml_flow FAILED      [100%]

================================== FAILURES ===================================
_____________________________ test_sso_saml_flow ______________________________

client = <starlette.testclient.TestClient object at 0x0000024877E5F9D0>
db = <sqlalchemy.orm.session.Session object at 0x0000024877E5FC50>

    def test_sso_saml_flow(client: TestClient, db: Session):
        """
        Test SAML specific flows with mocks
        """
        # Setup Org and Config
        superuser_headers = get_superuser_headers(client, db)
        org_data = {
            "name": "SAML Org",
            "slug": "saml-test",
            "domain": "saml.test",
            "sso_enabled": True,
        }
        org_res = client.post(
            f"{settings.API_V1_STR}/sso/organizations",
            headers=superuser_headers,
            json=org_data,
        )
        org_id = org_res.json()["id"]
    
        saml_config = {
            "provider_type": "saml",
            "provider_name": "Test SAML",
            "entity_id": "https://idp.example.com",
            "sso_url": "https://idp.example.com/sso",
            "x509_cert": "MIID...",
            "jit_enabled": True,
        }
        client.post(
            f"{settings.API_V1_STR}/sso/organizations/{org_id}/sso-config",
            headers=superuser_headers,
            json=saml_config,
        )
    
        # Test Login Redirect
        # Mock SAML AuthNRequest generation
>       with patch("app.api.api_v1.endpoints.sso.SAMLService.get_login_url") as mock_url:
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\api\api_v1\test_sso_integration.py:192: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\Sarit\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:1479: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

name = 'app.api.api_v1.endpoints.sso.SAMLService'

    def resolve_name(name):
        """
        Resolve a name to an object.
    
        It is expected that `name` will be a string in one of the following
        formats, where W is shorthand for a valid Python identifier and dot stands
        for a literal period in these pseudo-regexes:
    
        W(.W)*
        W(.W)*:(W(.W)*)?
    
        The first form is intended for backward compatibility only. It assumes that
        some part of the dotted name is a package, and the rest is an object
        somewhere within that package, possibly nested inside other objects.
        Because the place where the package stops and the object hierarchy starts
        can't be inferred by inspection, repeated attempts to import must be done
        with this form.
    
        In the second form, the caller makes the division point clear through the
        provision of a single colon: the dotted name to the left of the colon is a
        package to be imported, and the dotted name to the right is the object
        hierarchy within that package. Only one import is needed in this form. If
        it ends with the colon, then a module object is returned.
    
        The function will return an object (which might be a module), or raise one
        of the following exceptions:
    
        ValueError - if `name` isn't in a recognised format
        ImportError - if an import failed when it shouldn't have
        AttributeError - if a failure occurred when traversing the object hierarchy
                         within the imported package to get to the desired object.
        """
        global _NAME_PATTERN
        if _NAME_PATTERN is None:
            # Lazy import to speedup Python startup time
            import re
            dotted_words = r'(?!\d)(\w+)(\.(?!\d)(\w+))*'
            _NAME_PATTERN = re.compile(f'^(?P<pkg>{dotted_words})'
                                       f'(?P<cln>:(?P<obj>{dotted_words})?)?$',
                                       re.UNICODE)
    
        m = _NAME_PATTERN.match(name)
        if not m:
            raise ValueError(f'invalid format: {name!r}')
        gd = m.groupdict()
        if gd.get('cln'):
            # there is a colon - a one-step import is all that's needed
            mod = importlib.import_module(gd['pkg'])
            parts = gd.get('obj')
            parts = parts.split('.') if parts else []
        else:
            # no colon - have to iterate to find the package boundary
            parts = name.split('.')
            modname = parts.pop(0)
            # first part *must* be a module/package.
            mod = importlib.import_module(modname)
            while parts:
                p = parts[0]
                s = f'{modname}.{p}'
                try:
                    mod = importlib.import_module(s)
                    parts.pop(0)
                    modname = s
                except ImportError:
                    break
        # if we reach this point, mod is the module, already imported, and
        # parts is the list of parts in the object hierarchy to be traversed, or
        # an empty list if just the module is wanted.
        result = mod
        for p in parts:
>           result = getattr(result, p)
                     ^^^^^^^^^^^^^^^^^^
E           AttributeError: module 'app.api.api_v1.endpoints.sso' has no attribute 'SAMLService'. Did you mean: 'SSOService'?

C:\Users\Sarit\AppData\Local\Programs\Python\Python313\Lib\pkgutil.py:528: AttributeError
---------------------------- Captured stdout call -----------------------------
Getting superuser headers...
Creating superuser...
Logging in superuser...
-------------------------- Captured stdout teardown ---------------------------
DEBUG: Tearing down test db
============================== warnings summary ===============================
app\schemas\coupon.py:28
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\coupon.py:28: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator("discount_type")

app\schemas\coupon.py:34
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\coupon.py:34: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator("discount_value")

app\schemas\coupon.py:54
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\coupon.py:54: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Coupon(CouponBase):

app\schemas\digital_product.py:26
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\digital_product.py:26: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class DigitalProductInDBBase(DigitalProductBase):

C:\Users\Sarit\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_config.py:383
C:\Users\Sarit\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_config.py:383
C:\Users\Sarit\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_config.py:383
C:\Users\Sarit\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_config.py:383
  C:\Users\Sarit\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\_internal\_config.py:383: UserWarning: Valid config keys have changed in V2:
  * 'orm_mode' has been renamed to 'from_attributes'
    warnings.warn(message, UserWarning)

app\schemas\enquiry.py:25
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\enquiry.py:25: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class EnquiryInDBBase(EnquiryBase):

app\schemas\asset.py:24
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\asset.py:24: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AssetInDBBase(AssetBase):

app\schemas\analytics.py:29
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\analytics.py:29: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class InstructorAnalyticsResponse(InstructorAnalyticsBase):

app\schemas\analytics.py:98
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\analytics.py:98: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class StudentAnalyticsResponse(StudentAnalyticsBase):

app\schemas\analytics.py:161
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\analytics.py:161: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PlatformAnalyticsResponse(PlatformAnalyticsBase):

app\schemas\analytics.py:244
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\analytics.py:244: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class EventResponse(BaseModel):

app\schemas\marketplace.py:48
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\marketplace.py:48: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PayoutResponse(BaseModel):

app\schemas\marketplace.py:89
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\marketplace.py:89: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class BundleResponse(BaseModel):

app\schemas\marketplace.py:119
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\marketplace.py:119: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PlanResponse(BaseModel):

app\schemas\marketplace.py:134
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\marketplace.py:134: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class SubscriptionResponse(BaseModel):

app\api\api_v1\endpoints\revenue_analytics.py:54
  D:\Graphology\Master Software\Eduecosystem\backend\app\api\api_v1\endpoints\revenue_analytics.py:54: DeprecationWarning: `regex` has been deprecated, please use `pattern` instead
    comparison_type: str = Query("mom", regex="^(mom|yoy|custom)$"),

app\schemas\payment_method.py:37
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\payment_method.py:37: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PaymentMethodResponse(BaseModel):

app\schemas\translation.py:42
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\translation.py:42: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Language(LanguageBase):

app\schemas\translation.py:75
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\translation.py:75: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Translation(TranslationBase):

app\schemas\translation.py:126
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\translation.py:126: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ContentTranslation(ContentTranslationBase):

app\schemas\translation.py:187
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\translation.py:187: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class UserLanguagePreference(UserLanguagePreferenceBase):

app\api\api_v1\endpoints\ai_tools.py:31
  D:\Graphology\Master Software\Eduecosystem\backend\app\api\api_v1\endpoints\ai_tools.py:31: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class EssayGradeResponse(BaseModel):

app\api\api_v1\endpoints\ai_tools.py:67
  D:\Graphology\Master Software\Eduecosystem\backend\app\api\api_v1\endpoints\ai_tools.py:67: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class DifficultyAnalysisResponse(BaseModel):

app\api\api_v1\endpoints\ai_tools.py:86
  D:\Graphology\Master Software\Eduecosystem\backend\app\api\api_v1\endpoints\ai_tools.py:86: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PlagiarismCheckResponse(BaseModel):

app\api\api_v1\endpoints\sso.py:45
  D:\Graphology\Master Software\Eduecosystem\backend\app\api\api_v1\endpoints\sso.py:45: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class OrganizationResponse(BaseModel):

app\api\api_v1\endpoints\sso.py:78
  D:\Graphology\Master Software\Eduecosystem\backend\app\api\api_v1\endpoints\sso.py:78: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class SSOConfigResponse(BaseModel):

app\api\api_v1\endpoints\sso.py:98
  D:\Graphology\Master Software\Eduecosystem\backend\app\api\api_v1\endpoints\sso.py:98: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class SSOSessionResponse(BaseModel):

app\api\api_v1\endpoints\sso.py:109
  D:\Graphology\Master Software\Eduecosystem\backend\app\api\api_v1\endpoints\sso.py:109: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class SSOEventResponse(BaseModel):

app\schemas\tax.py:61
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\tax.py:61: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TaxRateResponse(TaxRateBase):

app\schemas\tax.py:101
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\tax.py:101: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TaxCalculationDetail(BaseModel):

app\schemas\tax.py:152
  D:\Graphology\Master Software\Eduecosystem\backend\app\schemas\tax.py:152: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TaxExemptionResponse(TaxExemptionBase):

app\api\api_v1\endpoints\exports.py:25
  D:\Graphology\Master Software\Eduecosystem\backend\app\api\api_v1\endpoints\exports.py:25: DeprecationWarning: `regex` has been deprecated, please use `pattern` instead
    format: str = Query("csv", regex="^(csv|pdf|json)$"),

app\api\api_v1\endpoints\exports.py:75
  D:\Graphology\Master Software\Eduecosystem\backend\app\api\api_v1\endpoints\exports.py:75: DeprecationWarning: `regex` has been deprecated, please use `pattern` instead
    format: str = Query("json", regex="^(json|pdf)$"),

app\api\api_v1\endpoints\exports.py:117
  D:\Graphology\Master Software\Eduecosystem\backend\app\api\api_v1\endpoints\exports.py:117: DeprecationWarning: `regex` has been deprecated, please use `pattern` instead
    format: str = Query("json", regex="^(json|pdf)$"),

app\api\api_v1\endpoints\exports.py:156
  D:\Graphology\Master Software\Eduecosystem\backend\app\api\api_v1\endpoints\exports.py:156: DeprecationWarning: `regex` has been deprecated, please use `pattern` instead
    format: str = Query("csv", regex="^(csv|pdf)$"),

app\api\api_v1\endpoints\learning_groups.py:39
  D:\Graphology\Master Software\Eduecosystem\backend\app\api\api_v1\endpoints\learning_groups.py:39: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class GroupResponse(BaseModel):

app\api\api_v1\endpoints\learning_groups.py:58
  D:\Graphology\Master Software\Eduecosystem\backend\app\api\api_v1\endpoints\learning_groups.py:58: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class PostResponse(BaseModel):

tests/api/api_v1/test_sso_integration.py::test_sso_full_flow
tests/api/api_v1/test_sso_integration.py::test_sso_saml_flow
  D:\Graphology\Master Software\Eduecosystem\backend\app\services\coin_service.py:231: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow()

tests/api/api_v1/test_sso_integration.py::test_sso_full_flow
tests/api/api_v1/test_sso_integration.py::test_sso_full_flow
tests/api/api_v1/test_sso_integration.py::test_sso_saml_flow
  D:\Graphology\Master Software\Eduecosystem\backend\app\core\security.py:16: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    expire = datetime.utcnow() + expires_delta

tests/api/api_v1/test_sso_integration.py::test_sso_full_flow
  D:\Graphology\Master Software\Eduecosystem\backend\app\services\sso_service.py:218: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    expires_at = datetime.utcnow() + timedelta(hours=session_timeout_hours)

tests/api/api_v1/test_sso_integration.py::test_sso_saml_flow
  D:\Graphology\Master Software\Eduecosystem\backend\conftest.py:85: SAWarning: Can't sort tables for DROP; an unresolvable foreign key dependency exists between tables: lessons, modules, quizzes; and backend does not support ALTER.  To restore at least a partial sort, apply use_alter=True to ForeignKey and ForeignKeyConstraint objects involved in the cycle to mark these as known cycles that will be ignored.
    Base.metadata.drop_all(bind=engine)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/api/api_v1/test_sso_integration.py::test_sso_saml_flow - Attribu...
============ 1 failed, 1 passed, 47 warnings in 124.02s (0:02:04) =============
