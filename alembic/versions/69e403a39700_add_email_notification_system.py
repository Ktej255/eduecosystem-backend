"""add_email_notification_system

Revision ID: 69e403a39700
Revises: 5e81665b4116
Create Date: 2025-11-25 11:29:57.028915

"""

from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import sqlite

# revision identifiers, used by Alembic.
revision: str = "69e403a39700"
down_revision: Union[str, Sequence[str], None] = "5e81665b4116"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "email_templates",
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("name", sa.String(), nullable=False),
        sa.Column("display_name", sa.String(), nullable=False),
        sa.Column("subject", sa.String(), nullable=False),
        sa.Column("body_html", sa.Text(), nullable=False),
        sa.Column("body_text", sa.Text(), nullable=True),
        sa.Column("variables", sa.JSON(), nullable=True),
        sa.Column("is_system", sa.Boolean(), nullable=True),
        sa.Column(
            "notification_type",
            sa.Enum(
                "ENROLLMENT",
                "ASSIGNMENT_SUBMITTED",
                "ASSIGNMENT_GRADED",
                "QUIZ_COMPLETED",
                "QUIZ_GRADED",
                "CERTIFICATE_EARNED",
                "ANNOUNCEMENT",
                "REVIEW_RECEIVED",
                "COURSE_UPDATED",
                "GENERAL",
                name="notificationtype",
            ),
            nullable=False,
        ),
        sa.Column("created_by", sa.Integer(), nullable=True),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.ForeignKeyConstraint(["created_by"], ["users.id"], ondelete="SET NULL"),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_email_templates_id"), "email_templates", ["id"], unique=False
    )
    op.create_index(
        op.f("ix_email_templates_name"), "email_templates", ["name"], unique=True
    )
    op.create_index(
        op.f("ix_email_templates_notification_type"),
        "email_templates",
        ["notification_type"],
        unique=False,
    )
    op.create_table(
        "user_email_preferences",
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("user_id", sa.Integer(), nullable=False),
        sa.Column("enrollment_enabled", sa.Boolean(), nullable=True),
        sa.Column("assignment_enabled", sa.Boolean(), nullable=True),
        sa.Column("quiz_enabled", sa.Boolean(), nullable=True),
        sa.Column("certificate_enabled", sa.Boolean(), nullable=True),
        sa.Column("announcement_enabled", sa.Boolean(), nullable=True),
        sa.Column("review_enabled", sa.Boolean(), nullable=True),
        sa.Column("course_update_enabled", sa.Boolean(), nullable=True),
        sa.Column("general_enabled", sa.Boolean(), nullable=True),
        sa.Column("all_emails_enabled", sa.Boolean(), nullable=True),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.ForeignKeyConstraint(["user_id"], ["users.id"], ondelete="CASCADE"),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_user_email_preferences_id"),
        "user_email_preferences",
        ["id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_user_email_preferences_user_id"),
        "user_email_preferences",
        ["user_id"],
        unique=True,
    )
    op.create_table(
        "email_logs",
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("user_id", sa.Integer(), nullable=False),
        sa.Column("template_id", sa.Integer(), nullable=True),
        sa.Column("recipient_email", sa.String(), nullable=False),
        sa.Column("subject", sa.String(), nullable=False),
        sa.Column(
            "status",
            sa.Enum("PENDING", "SENT", "FAILED", "BOUNCED", name="emailstatus"),
            nullable=True,
        ),
        sa.Column("sent_at", sa.DateTime(), nullable=True),
        sa.Column("error_message", sa.Text(), nullable=True),
        sa.Column("body_html", sa.Text(), nullable=True),
        sa.Column("body_text", sa.Text(), nullable=True),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.ForeignKeyConstraint(
            ["template_id"], ["email_templates.id"], ondelete="SET NULL"
        ),
        sa.ForeignKeyConstraint(["user_id"], ["users.id"], ondelete="CASCADE"),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_email_logs_created_at"), "email_logs", ["created_at"], unique=False
    )
    op.create_index(op.f("ix_email_logs_id"), "email_logs", ["id"], unique=False)
    op.create_index(
        op.f("ix_email_logs_status"), "email_logs", ["status"], unique=False
    )
    op.create_index(
        op.f("ix_email_logs_user_id"), "email_logs", ["user_id"], unique=False
    )
    op.alter_column(
        "ai_grading_results",
        "student_answer_id",
        existing_type=sa.INTEGER(),
        nullable=True,
    )
    op.drop_index(
        op.f("ix_ai_grading_results_needs_manual_review"),
        table_name="ai_grading_results",
    )
    op.drop_index(
        op.f("ix_ai_grading_results_student_answer_id"), table_name="ai_grading_results"
    )
    op.create_index(
        op.f("ix_ai_grading_results_id"), "ai_grading_results", ["id"], unique=False
    )
    op.drop_constraint(None, "ai_grading_results", type_="foreignkey")
    op.create_foreign_key(
        None, "ai_grading_results", "student_answers", ["student_answer_id"], ["id"]
    )
    op.drop_index(
        op.f("ix_assessment_rubrics_question_id"), table_name="assessment_rubrics"
    )
    op.create_index(
        op.f("ix_assessment_rubrics_id"), "assessment_rubrics", ["id"], unique=False
    )
    op.drop_constraint(None, "assessment_rubrics", type_="foreignkey")
    op.create_foreign_key(
        None, "assessment_rubrics", "questions", ["question_id"], ["id"]
    )
    op.add_column("courses", sa.Column("category_id", sa.Integer(), nullable=True))
    op.add_column(
        "courses", sa.Column("is_password_protected", sa.Boolean(), nullable=True)
    )
    op.add_column("courses", sa.Column("password_hash", sa.String(), nullable=True))
    op.drop_index(op.f("ix_courses_category"), table_name="courses")
    op.create_index(
        op.f("ix_courses_category_id"), "courses", ["category_id"], unique=False
    )
    op.create_foreign_key(None, "courses", "categories", ["category_id"], ["id"])
    op.drop_column("courses", "page_layout")
    op.drop_column("courses", "tags")
    op.drop_column("courses", "category")
    op.add_column("lessons", sa.Column("video_provider", sa.String(), nullable=True))
    op.add_column("lessons", sa.Column("video_id", sa.String(), nullable=True))
    op.add_column(
        "lessons", sa.Column("video_thumbnail_url", sa.String(), nullable=True)
    )
    op.add_column("lessons", sa.Column("video_status", sa.String(), nullable=True))
    op.add_column(
        "lessons", sa.Column("video_uploaded_at", sa.DateTime(), nullable=True)
    )
    op.add_column(
        "notifications",
        sa.Column(
            "priority",
            sa.Enum("LOW", "NORMAL", "HIGH", "URGENT", name="notificationpriority"),
            nullable=True,
        ),
    )
    op.add_column(
        "notifications", sa.Column("delivered_realtime", sa.Boolean(), nullable=True)
    )
    op.add_column(
        "notifications", sa.Column("delivered_push", sa.Boolean(), nullable=True)
    )
    op.add_column(
        "notifications", sa.Column("delivered_email", sa.Boolean(), nullable=True)
    )
    op.alter_column(
        "notifications",
        "is_read",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("'false'"),
    )
    op.alter_column(
        "notifications",
        "created_at",
        existing_type=sa.DATETIME(),
        nullable=True,
        existing_server_default=sa.text("(now())"),
    )
    op.create_index(
        op.f("ix_notifications_priority"), "notifications", ["priority"], unique=False
    )
    op.alter_column(
        "quiz_attempt_analytics",
        "attempt_id",
        existing_type=sa.INTEGER(),
        nullable=True,
    )
    op.drop_index(
        op.f("ix_quiz_attempt_analytics_attempt_id"),
        table_name="quiz_attempt_analytics",
    )
    op.create_index(
        op.f("ix_quiz_attempt_analytics_id"),
        "quiz_attempt_analytics",
        ["id"],
        unique=False,
    )
    op.drop_constraint(None, "quiz_attempt_analytics", type_="foreignkey")
    op.create_foreign_key(
        None, "quiz_attempt_analytics", "quiz_attempts", ["attempt_id"], ["id"]
    )
    op.drop_index(op.f("ix_quiz_feedback_question_id"), table_name="quiz_feedback")
    op.create_index(op.f("ix_quiz_feedback_id"), "quiz_feedback", ["id"], unique=False)
    op.drop_constraint(None, "quiz_feedback", type_="foreignkey")
    op.create_foreign_key(None, "quiz_feedback", "questions", ["question_id"], ["id"])
    op.drop_index(op.f("idx_users_active"), table_name="users")
    op.drop_index(op.f("idx_users_email"), table_name="users")
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_index(op.f("idx_users_email"), "users", ["email"], unique=False)
    op.create_index(op.f("idx_users_active"), "users", ["is_active"], unique=False)
    op.drop_constraint(None, "quiz_feedback", type_="foreignkey")
    op.create_foreign_key(
        None, "quiz_feedback", "questions", ["question_id"], ["id"], ondelete="CASCADE"
    )
    op.drop_index(op.f("ix_quiz_feedback_id"), table_name="quiz_feedback")
    op.create_index(
        op.f("ix_quiz_feedback_question_id"),
        "quiz_feedback",
        ["question_id"],
        unique=False,
    )
    op.drop_constraint(None, "quiz_attempt_analytics", type_="foreignkey")
    op.create_foreign_key(
        None,
        "quiz_attempt_analytics",
        "quiz_attempts",
        ["attempt_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.drop_index(
        op.f("ix_quiz_attempt_analytics_id"), table_name="quiz_attempt_analytics"
    )
    op.create_index(
        op.f("ix_quiz_attempt_analytics_attempt_id"),
        "quiz_attempt_analytics",
        ["attempt_id"],
        unique=1,
    )
    op.alter_column(
        "quiz_attempt_analytics",
        "attempt_id",
        existing_type=sa.INTEGER(),
        nullable=False,
    )
    op.drop_index(op.f("ix_notifications_priority"), table_name="notifications")
    op.alter_column(
        "notifications",
        "created_at",
        existing_type=sa.DATETIME(),
        nullable=False,
        existing_server_default=sa.text("(now())"),
    )
    op.alter_column(
        "notifications",
        "is_read",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("'false'"),
    )
    op.drop_column("notifications", "delivered_email")
    op.drop_column("notifications", "delivered_push")
    op.drop_column("notifications", "delivered_realtime")
    op.drop_column("notifications", "priority")
    op.drop_column("lessons", "video_uploaded_at")
    op.drop_column("lessons", "video_status")
    op.drop_column("lessons", "video_thumbnail_url")
    op.drop_column("lessons", "video_id")
    op.drop_column("lessons", "video_provider")
    op.add_column(
        "courses", sa.Column("category", sa.VARCHAR(length=20), nullable=True)
    )
    op.add_column("courses", sa.Column("tags", sqlite.JSON(), nullable=True))
    op.add_column("courses", sa.Column("page_layout", sqlite.JSON(), nullable=True))
    op.drop_constraint(None, "courses", type_="foreignkey")
    op.drop_index(op.f("ix_courses_category_id"), table_name="courses")
    op.create_index(op.f("ix_courses_category"), "courses", ["category"], unique=False)
    op.drop_column("courses", "password_hash")
    op.drop_column("courses", "is_password_protected")
    op.drop_column("courses", "category_id")
    op.drop_constraint(None, "assessment_rubrics", type_="foreignkey")
    op.create_foreign_key(
        None,
        "assessment_rubrics",
        "questions",
        ["question_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.drop_index(op.f("ix_assessment_rubrics_id"), table_name="assessment_rubrics")
    op.create_index(
        op.f("ix_assessment_rubrics_question_id"),
        "assessment_rubrics",
        ["question_id"],
        unique=False,
    )
    op.drop_constraint(None, "ai_grading_results", type_="foreignkey")
    op.create_foreign_key(
        None,
        "ai_grading_results",
        "student_answers",
        ["student_answer_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.drop_index(op.f("ix_ai_grading_results_id"), table_name="ai_grading_results")
    op.create_index(
        op.f("ix_ai_grading_results_student_answer_id"),
        "ai_grading_results",
        ["student_answer_id"],
        unique=1,
    )
    op.create_index(
        op.f("ix_ai_grading_results_needs_manual_review"),
        "ai_grading_results",
        ["needs_manual_review"],
        unique=False,
    )
    op.alter_column(
        "ai_grading_results",
        "student_answer_id",
        existing_type=sa.INTEGER(),
        nullable=False,
    )
    op.drop_index(op.f("ix_email_logs_user_id"), table_name="email_logs")
    op.drop_index(op.f("ix_email_logs_status"), table_name="email_logs")
    op.drop_index(op.f("ix_email_logs_id"), table_name="email_logs")
    op.drop_index(op.f("ix_email_logs_created_at"), table_name="email_logs")
    op.drop_table("email_logs")
    op.drop_index(
        op.f("ix_user_email_preferences_user_id"), table_name="user_email_preferences"
    )
    op.drop_index(
        op.f("ix_user_email_preferences_id"), table_name="user_email_preferences"
    )
    op.drop_table("user_email_preferences")
    op.drop_index(
        op.f("ix_email_templates_notification_type"), table_name="email_templates"
    )
    op.drop_index(op.f("ix_email_templates_name"), table_name="email_templates")
    op.drop_index(op.f("ix_email_templates_id"), table_name="email_templates")
    op.drop_table("email_templates")
    # ### end Alembic commands ###
